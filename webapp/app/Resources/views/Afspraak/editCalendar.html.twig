{% extends "::base.html.twig" %}
	{% block styles %}
        {{ parent() }}
        <link href={{ asset('vendor/fullcalendar-2.5.0/fullcalendar.css') }} rel='stylesheet'/>
        <link href={{ asset('vendor/fullcalendar-2.5.0/fullcalendar.print.css') }} rel='stylesheet' media='print'/>
        <script src={{ asset('vendor/fullcalendar-2.5.0/lib/moment.min.js') }}></script>
        <script src={{ asset('vendor/fullcalendar-2.5.0/lib/jquery.min.js') }}></script>
        <script src={{ asset('vendor/fullcalendar-2.5.0/fullcalendar.min.js') }}></script>
        <script src={{ asset('vendor/fullcalendar-2.5.0/lang/nl.js') }}></script>
        <script src={{ asset('vendor/bootbox/bootbox.min.js') }}></script>
        <link href={{ asset('css/calendarStyles.css') }} rel='stylesheet'/>
    {% endblock %}
    {% block breadcrumbs %}
        <ul class="breadcrumb">
            <li>
                <a href="{{ path(app.request.attributes.get('_route')) }}">
                    Afspraken beheren
                </a>
            </li>
        </ul>
    {% endblock %}
{% block body %}
    <div class="modal" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Afspraak verwijderen</h4>
                </div>

                <div class="modal-body">
                    <p>U staat op het punt onderstaande afspraak te verwijderen.</p>
                    <div class="well">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="appointmentDateTime" class="control-label">Datum en tijd</label>
                                    <div name="appointmentDateTime" id="appointmentDateTime"></div>
                                </div>
                                <div class="form-group">
                                    <label for="appointmentLocation" class="control-label">Locatie</label>
                                    <div name="appointmentLocation" id="appointmentLocation"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="patientName" class="control-label">Naam patiÃ«nt</label>
                                    <div name="patientName" id="patientName"></div>
                                </div>
                                <div class="form-group">
                                    <label for="patientMessage" class="control-label">Reden van consultatie</label>
                                    <div name="patientMessage" id="patientMessage"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Annuleren</button>
                    <a id="deleteAppointment" class="btn btn-danger btn-ok">Verwijderen</a>
                </div>
            </div>
        </div>
    </div>
    <section>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <section id="calendar-panel" class="panel panel-default">
                        <div class="panel-heading">
                            Agenda
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="room">Locatie</label>
                                        <!-- <input name="room" class="form-control" id="room" type="text" placeholder="Vul de locatie voor de afspraak in"/> -->
                                        <select name="room" id="room" class="form-control">
                                            {% for room in rooms %}
                                            <option value="{{ room.roomName }}">{{ room.roomName }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <img class="center-block margin10" id="preloader"
                                         src="{{ asset('preloader1.gif') }}"/>
                                    <div id="calendar"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </section>
    <script type="text/javascript">

        function loadData(url, callback) {
            $.ajax({
                url: url,
                dataType: 'json',
                type: 'get',
                success: function (data) {
                    callback(data);
                }
            })
        }

        $(document).ready(function () {

            prefs = [];
            prefs["minHour"] = '08:00';
            prefs["maxHour"] = '19:00';
            prefs["slotDuration"] = '00:15';

            var calendar = $('#calendar');
            calendar.fullCalendar('getCalendar');
            calendar.fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'agendaWeek,agendaDay'
                },
                firstDay: 1,
                allDaySlot: false,
                defaultDate: Date.now(),
                lang: 'nl',
                editable: false,
                timeFormat: 'HH:mm',
                defaultView: 'agendaWeek',
                minTime: prefs["minHour"],
                maxTime: prefs["maxHour"],
                scrollTime: prefs["minHour"],
                slotDuration: prefs["slotDuration"],
                slotLabelInterval: prefs["slotDuration"],
                slotLabelFormat: 'HH:mm',
                eventDurationEditable: false,
                snapDuration: prefs["slotDuration"],
                eventLimit: true,
                displayEventTime: true,
                displayEventEnd: true,
                slotEventOverlap: false,
                eventBackgroundColor: 'rgb(26, 36, 47)',
                defaultTimedEventDuration: prefs["slotDuration"],
                minDate: moment(Date.now()),
                loading: function (bool) {
                    if (bool) $('#preloader').show();
                    else $('#preloader').hide();
                },
                selectable: true,
                selectHelper: true,
                select: function (start, end) {
                    var appointment = new Object();
                    appointment.title = null;
                    appointment.start = start;
                    appointment.end = end;
                    appointment.doctorId = {{ app.user.id }};
                    appointment.room = $('#room').val();

                    calendar.fullCalendar('renderEvent',
                            {
                                title: appointment.title,
                                start: appointment.start,
                                end: appointment.end
                            },
                            true
                    );

                    $.ajax({
                        url: "http://localhost:8000/api/appointments",
                        type: 'post',
                        dataType: "json",
                        processData: false,
                        beforeSend: function (request) {
                            request.setRequestHeader("Content-Type", "application/json");
                        },
                        data: JSON.stringify(appointment),
                        success: function (msg) {
                            //$("#results").append("The result = " + msg);
                        }
                    });

                    calendar.fullCalendar('unselect');
                },
                eventClick: function (event, jsEvent, view) {
                    if($(this).css("background-color") === "rgb(71, 98, 127)") {

                        $(this).attr('data-toggle', 'modal');
                        $(this).attr('data-target', '#confirm-delete');
                        //$("#deleteAppointment").attr('data-appointment', event._id);

                        $("#appointmentDateTime").html(moment(event.start).format('DD MMM') + " " + moment(event.start).format('HH:mm') + " - " + moment(event.end).format('HH:mm'))
                        $("#appointmentLocation").html(event.room);
                        $("#patientName").html(event.patientname);
                        $("#patientMessage").html(event.message);
                    } else {
                        deleteAppointment(event._id);
                    }
                }
            });

            function deleteAppointment(appointmentId) {
                $(this).hide();
                calendar.fullCalendar('removeEvents', appointmentId);
                calendar.fullCalendar('rerenderEvents');
                $.ajax({
                    url: "http://localhost:8000/api/appointments/" + appointmentId,
                    type: 'delete',
                    dataType: "json",
                    processData: false,
                    beforeSend: function (request) {
                        request.setRequestHeader("Content-Type", "application/json");
                    },
                    success: function (msg) {
                        //$("#results").append("The result = " + msg);
                    }
                });
            }

            loadAppointments({{ app.user.id }});

            function loadAppointments(doctorId) {
                loadData('http://localhost:8000/api/doctors/' + doctorId + '/appointments/open', function (appointments) {
                    $('#preloader').hide();
                    calendar.fullCalendar('addEventSource', appointments);
                    calendar.fullCalendar('refetchEvents');
                });
                loadData('http://localhost:8000/api/doctors/' + doctorId + '/appointments/closed', function (appointments) {
                    $('#preloader').hide();
                    calendar.fullCalendar('addEventSource', {
                        events: appointments,
                        color: 'rgb(71, 98, 127)'
                    });
                    calendar.fullCalendar('refetchEvents');
                });
            }

        });
    </script>
{% endblock %}
